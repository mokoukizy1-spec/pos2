<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>行動點餐</title>
  <style>
    :root{
      --primary:#ff9800; --danger:#d32f2f; --bg:#f7f7f7; --card:#fff;
    }
    body{font-family:"Microsoft JhengHei UI",system-ui; margin:0; background:var(--bg);}
    .nav{padding:12px 16px; background:#ff6f61; color:#fff; font-weight:700;}
    .container{padding:12px 16px; max-width:960px; margin:0 auto;}
    .chips{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;}
    .chip{padding:8px 14px; border-radius:999px; background:#eee; cursor:pointer; user-select:none;}
    .chip.active{background:var(--primary); color:#fff;}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px;}
    .card{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,.08);}
    .card h4{margin:0 0 8px 0;}
    .qty{display:flex; align-items:center; gap:6px; justify-content:flex-end;}
    .btn{padding:10px 14px; border:none; border-radius:8px; cursor:pointer;}
    .btn.primary{background:var(--primary); color:#fff;}
    .btn.danger{background:var(--danger); color:#fff;}
    .bar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:16px;}
    .note{width:100%; height:96px; border-radius:8px; border:1px solid #ddd; padding:10px;}
    .hidden{display:none;}
    .inline{display:inline-block;}
    .label{font-weight:600;}
    .input{padding:8px 10px; border:1px solid #ddd; border-radius:8px;}
    .sum{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  </style>
</head>
<body>
  <div class="nav">行動點餐</div>
  <div class="container">
    <div class="chips">
      <div class="chip active" data-scene="內用">內用</div>
      <div class="chip" data-scene="外帶">外帶</div>
      <div class="chip" data-scene="外送">外送</div>
    </div>
    <div id="tableBox">
      <span class="label">桌號</span>
      <input id="tableNo" class="input" type="number" min="1" placeholder="請輸入桌號">
    </div>
    <div class="grid" id="menu"></div>
    <div class="sum" id="summary"></div>
    <textarea id="note" class="note" placeholder="備註（例如：不加辣、飯少一點）"></textarea>
    <div class="bar">
      <button id="clear" class="btn danger">清空</button>
      <button id="submit" class="btn primary">送出訂單</button>
    </div>
    <div id="result"></div>
  </div>
  <script>
    const API_BASE = location.origin; // 同站部署
    const menu = [
      {name:"舒肥里肌餐盒", price:125},
      {name:"舒肥雞腿餐盒", price:160},
      {name:"品名較長的舒肥里肌餐盒", price:142},
      {name:"EX暖食餐盒", price:125},
      {name:"EX自選暖食餐盒", price:125},
      {name:"LOKAL自選沙拉", price:160},
    ];
    const selected = new Map(); // name -> {unit_price, quantity, details}
    const menuEl = document.getElementById("menu");
    const summaryEl = document.getElementById("summary");
    const noteEl = document.getElementById("note");
    const tableBox = document.getElementById("tableBox");
    const tableNoEl = document.getElementById("tableNo");
    const sceneElts = Array.from(document.querySelectorAll(".chip"));
    let scene = "內用";
    sceneElts.forEach(ch => ch.addEventListener("click", () => {
      sceneElts.forEach(x => x.classList.remove("active"));
      ch.classList.add("active");
      scene = ch.dataset.scene;
      tableBox.classList.toggle("hidden", scene !== "內用");
    }));
    function renderMenu(){
      menuEl.innerHTML = "";
      menu.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        const h4 = document.createElement("h4");
        h4.textContent = item.name;
        const price = document.createElement("div");
        price.textContent = "$ " + item.price;
        const detail = document.createElement("input");
        detail.placeholder = "特殊要求（選填）";
        detail.className = "input";
        detail.style.width = "100%";
        detail.addEventListener("input", () => {
          const cur = selected.get(item.name);
          if(cur){ cur.details = detail.value; }
        });
        const qty = document.createElement("div");
        qty.className = "qty";
        const minus = document.createElement("button");
        minus.className = "btn";
        minus.textContent = "−";
        const count = document.createElement("span");
        count.textContent = "0";
        const plus = document.createElement("button");
        plus.className = "btn";
        plus.textContent = "+";
        minus.onclick = () => {
          const cur = selected.get(item.name);
          if(cur){
            cur.quantity = Math.max(0, cur.quantity-1);
            if(cur.quantity===0){ selected.delete(item.name); }
          }
          count.textContent = selected.get(item.name)?.quantity || 0;
          renderSummary();
        };
        plus.onclick = () => {
          const cur = selected.get(item.name) || {unit_price:item.price, quantity:0, details:""};
          cur.quantity += 1;
          selected.set(item.name, cur);
          count.textContent = cur.quantity;
          renderSummary();
        };
        qty.append(minus, count, plus);
        card.append(h4, price, detail, qty);
        menuEl.appendChild(card);
      });
    }
    function renderSummary(){
      let subtotal = 0, count = 0;
      summaryEl.innerHTML = "";
      selected.forEach((v,k) => {
        subtotal += v.unit_price * v.quantity;
        count += v.quantity;
        const line = document.createElement("div");
        line.textContent = `${k} x${v.quantity} @$${v.unit_price}` + (v.details?` ｜ ${v.details}`:"");
        summaryEl.appendChild(line);
      });
      const discount = Math.floor(subtotal * 0.05);
      const total = subtotal - discount;
      const info = document.createElement("div");
      info.textContent = `小計：${subtotal}　折扣(5%)：${discount}　合計：${total}　數量：${count}`;
      summaryEl.appendChild(info);
    }
    document.getElementById("clear").onclick = () => { selected.clear(); renderSummary(); };
    document.getElementById("submit").onclick = async () => {
      const items = Array.from(selected.entries()).map(([name, v]) => ({
        name, unit_price: v.unit_price, quantity: v.quantity, details: v.details||""
      })).filter(x => x.quantity>0);
      if(items.length===0){ alert("請選擇餐點"); return; }
      const payload = {
        dine_type: scene,
        table_no: scene==="內用" ? Number(tableNoEl.value||0) : null,
        note: noteEl.value||"",
        items
      };
      try{
        const r = await fetch(`${API_BASE}/api/orders`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if(r.status===409){ alert("桌號有人，請重新輸入"); return; }
        const data = await r.json();
        document.getElementById("result").textContent = `建立成功，訂單編號：${data.id}`;
        selected.clear(); renderSummary(); noteEl.value=""; tableNoEl.value="";
      }catch(e){
        alert("送出失敗，請稍後再試");
      }
    };
    renderMenu(); renderSummary();
    tableBox.classList.toggle("hidden", scene !== "內用");
  </script>
</body>
</html>
